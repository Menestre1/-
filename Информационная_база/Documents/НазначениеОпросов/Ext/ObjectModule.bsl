#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ОбработчикиСобытий

// Поместить в Модуль Объекта документа "НазначениеОпросов"

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)

	Если ТипЗнч(ДанныеЗаполнения) = Тип("СправочникСсылка.ШаблоныБинарныхДеревьев") Тогда
		// Заполнение шапки
		Наименование = ДанныеЗаполнения.Наименование;
		ШаблонТеста = ДанныеЗаполнения.Ссылка;
		СвободныйОпрос = Истина;
		ПоказыватьВАрхивеАнкет = Ложь;
		ДатаНачала = ТекущаяДата();
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Дата) Тогда
		Дата = НачалоДня(ОбщегоНазначения.ТекущаяДатаПользователя());
	КонецЕсли;

КонецПроцедуры

#КонецОбласти

// Поместить в Модуль Объекта документа "НазначениеОпросов"

Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	
	Если НЕ ЗначениеЗаполнено(ЭтотОбъект.ШаблонТеста) Тогда
		Сообщить("Не указан шаблон теста!"); Отказ = Истина; Возврат;
	КонецЕсли;

	Если ЭтотОбъект.Респонденты.Количество() = 0 Тогда
		Сообщить("Не указан ни один респондент!"); Отказ = Истина; Возврат;
	КонецЕсли;

	Для Каждого СтрокаРеспондента Из ЭтотОбъект.Респонденты Цикл
		
		// --- НОВАЯ УЛУЧШЕННАЯ ЛОГИКА ---
		
		// 1. Создаем объект документа
		НовыйТест = Документы.ТестБинарноеДерево.СоздатьДокумент();
		
		// 2. Явно и надежно заполняем все необходимые реквизиты ДО записи
		НовыйТест.Опрос = ЭтотОбъект.Ссылка;
		НовыйТест.ШаблонТеста = ЭтотОбъект.ШаблонТеста;
		НовыйТест.Респондент = СтрокаРеспондента.Респондент;
		НовыйТест.Дата = ТекущаяДата();
		
		// 3. Вызываем ОбработкуЗаполнения, чтобы подтянулась структура дерева и прочая логика
		НовыйТест.ОбработкаЗаполнения(ЭтотОбъект.Ссылка);
		
		// 4. Записываем полностью готовый документ
		Попытка
			НовыйТест.Записать(РежимЗаписиДокумента.Запись); // Просто записываем, не проводим
		Исключение
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = "Не удалось создать тест для респондента '" + СтрокаРеспондента.Респондент 
			                + "'. Ошибка: " + ОписаниеОшибки();
			Сообщение.Сообщить();
			Отказ = Истина;
			Возврат;
		КонецПопытки;
		
	КонецЦикла;
	
КонецПроцедуры

#КонецЕсли
