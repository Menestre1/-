
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Свойство("АвтоТест") Тогда // Возврат при получении формы для анализа.
		Возврат;
	КонецЕсли;

	Если Не ОбщегоНазначения.ПриСозданииНаСервере(ЭтотОбъект, Отказ, СтандартнаяОбработка) Тогда
		Возврат;
	КонецЕсли;
	
	ТекущийПользователь = Пользователи.АвторизованныйПользователь();
	Если ТипЗнч(ТекущийПользователь) <> Тип("СправочникСсылка.ВнешниеПользователи") Тогда 
		Объект.Респондент = ТекущийПользователь;
		//Элементы.Страницы.ТекущаяСтраница = Элементы.ИнформацияДляПользователя;
	Иначе	
		Объект.Респондент = ВнешниеПользователи.ПолучитьОбъектАвторизацииВнешнегоПользователя(ТекущийПользователь);
	КонецЕсли;
	
	ПолучитьТаблицуАнкетРеспондента();
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	Если ИмяСобытия = "Запись_Тест" ИЛИ ИмяСобытия = "Проведение_Тест" Тогда
		ПолучитьТаблицуАнкетРеспондента();
	КонецЕсли;
	
КонецПроцедуры 

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

// Поместить в Модуль ФОРМЫ Обработки "СписокРеспондента"

&НаКлиенте
Процедура ДеревоАнкетПередНачаломИзменения(Элемент, Отказ)
	
	Отказ = Истина;
	
	ТекущиеДанные = Элементы.ТаблицаАнкет.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено ИЛИ НЕ ЗначениеЗаполнено(ТекущиеДанные.АнкетаОпрос) Тогда
		Возврат;
	КонецЕсли;

	// Сценарий 1: Пользователь кликнул на уже существующий, начатый тест
	Если ТипЗнч(ТекущиеДанные.АнкетаОпрос) = Тип("ДокументСсылка.ТестБинарноеДерево") Тогда
		
		// Просто открываем форму этого документа. ОбработкаЗаполнения не будет вызвана.
		ОткрытьФорму("Документ.ТестБинарноеДерево.Форма.ФормаДокумента", Новый Структура("Ключ", ТекущиеДанные.АнкетаОпрос), Элемент);
		
	// Сценарий 2: Пользователь кликнул на новое "Назначение опросов"
	ИначеЕсли ТипЗнч(ТекущиеДанные.АнкетаОпрос) = Тип("ДокументСсылка.НазначениеОпросов") Тогда
		
		// --- ФИНАЛЬНАЯ ПРАВИЛЬНАЯ ЛОГИКА ---
		// Мы не просто открываем форму, мы сначала на сервере СОЗДАЕМ и ЗАПИСЫВАЕМ документ,
		// а потом открываем форму УЖЕ СУЩЕСТВУЮЩЕГО документа.
		
		// Вызываем серверную функцию, которая сделает всю работу
		СсылкаНаНовыйТест = СоздатьИЗаписатьНовыйТестНаСервере(ТекущиеДанные.АнкетаОпрос);
		
		// Если тест был успешно создан, открываем его форму
		Если ЗначениеЗаполнено(СсылкаНаНовыйТест) Тогда
			ОткрытьФорму("Документ.ТестБинарноеДерево.Форма.ФормаДокумента", Новый Структура("Ключ", СсылкаНаНовыйТест), Элемент);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры


// Поместить в Модуль ФОРМЫ Обработки "СписокРеспондента"

&НаСервере
Функция СоздатьИЗаписатьНовыйТестНаСервере(НазначениеОпроса)

	// 1. Создаем объект документа
	НовыйТест = Документы.ТестБинарноеДерево.СоздатьДокумент();
	
	// 2. Формируем структуру с данными для заполнения
	ДанныеДляЗаполнения = Новый Структура;
	ДанныеДляЗаполнения.Вставить("Опрос", НазначениеОпроса);
	ДанныеДляЗаполнения.Вставить("Респондент", Объект.Респондент);
	
	// 3. Вызываем ОбработкуЗаполнения, передавая ей все нужные данные
	НовыйТест.ОбработкаЗаполнения(ДанныеДляЗаполнения);
	
	// 4. Записываем полностью готовый документ
	Попытка
		НовыйТест.Записать(РежимЗаписиДокумента.Запись);
		// Возвращаем ссылку на успешно записанный документ
		Возврат НовыйТест.Ссылка;
	Исключение
		Сообщить("Не удалось создать новый тест. Ошибка: " + ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;

КонецФункции

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура АрхивАнкет(Команда)
	
	ОткрытьФорму("Обработка.СписокРеспондента.Форма.АрхивАнкет",Новый Структура("Респондент",Объект.Респондент),ЭтотОбъект);
	
КонецПроцедуры 

&НаКлиенте
Процедура Обновить(Команда)
	
	ПолучитьТаблицуАнкетРеспондента();
	
КонецПроцедуры 

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ПолучитьТаблицуАнкетРеспондента()
    
    ТаблицаАнкет.Очистить();
    
    ПолученнаяТаблицаАнкет = БазыБинарныеТестыДдеревьяРешений.ПолучитьТаблицуДоступныхРеспондентуАнкет(Объект.Респондент);
    
    Если ПолученнаяТаблицаАнкет <> Неопределено Тогда
        
        Для каждого СтрокаТаблицы Из ПолученнаяТаблицаАнкет Цикл
            
            НоваяСтрока = ТаблицаАнкет.Добавить();
            Если НЕ ЗначениеЗаполнено(СтрокаТаблицы.АнкетаОпрос) Тогда
                
                НоваяСтрока.Представление = СтрокаТаблицы.Статус;
                НоваяСтрока.Статус        = СтрокаТаблицы.Статус;
                
            Иначе
                
                НоваяСтрока.Статус        = СтрокаТаблицы.Статус;
                
                // --- ВАЖНОЕ ИСПРАВЛЕНИЕ: Раскомментирована строка ---
                // Теперь мы сохраняем ссылку на документ в нашу невидимую колонку
                НоваяСтрока.АнкетаОпрос   = СтрокаТаблицы.АнкетаОпрос;
                
                НоваяСтрока.Представление = ПолучитьПредставлениеСтрокиДереваАнкеты(СтрокаТаблицы);
                
            КонецЕсли;
            
            // Эту строку нужно перенести внутрь цикла
            НоваяСтрока.КодКартинки = ?(СтрокаТаблицы.Статус = "Опросы", 0, 1);
            
        КонецЦикла;
        
    КонецЕсли;
    
КонецПроцедуры

// Формирует представление строки для дерева анкет.
//
// Параметры:
//  СтрокаДерева  - СтрокаДереваЗначений - на основании ее формируется представление 
//                 анкет и опросов в дереве.
&НаСервере
Функция ПолучитьПредставлениеСтрокиДереваАнкеты(СтрокаДерева)
	
	СтрокаВозврата = "";
	
	ЕстьОграниченияПоСроку = ЗначениеЗаполнено(СтрокаДерева.ДатаОкончания);
	Закончился = ?(ЗначениеЗаполнено(СтрокаДерева.ДатаОкончания),
		?(ТекущаяДатаСеанса() <= СтрокаДерева.ДатаОкончания, Ложь, Истина), Ложь);
	
	Если ТипЗнч(СтрокаДерева.АнкетаОпрос) = Тип("ДокументСсылка.НазначениеОпросов") Тогда
		СтрокаВозврата = СтрокаВозврата + НСтр("ru = 'Тест'") + " '" + СтрокаДерева.Наименование + "'";
	ИначеЕсли ТипЗнч(СтрокаДерева.АнкетаОпрос) = Тип("ДокументСсылка.ТестБинарноеДерево") Тогда
		СтрокаВозврата = СтрокаВозврата + НСтр("ru = 'Тест'") + " '" + СтрокаДерева.Наименование 
		+ "', " + НСтр("ru = 'последний раз редактировавшаяся'") + " " + Формат(СтрокаДерева.ДатаАнкеты, "ДЛФ=D");
	Иначе	
		Возврат СтрокаВозврата;
	КонецЕсли;
	
	Если ЕстьОграниченияПоСроку Тогда
			СтрокаВозврата = СтрокаВозврата + ", " + НСтр("ru = 'к заполнению до'") + " " + Формат(НачалоДня(КонецДня(СтрокаДерева.ДатаОкончания) + 1),"ДЛФ=D");
	КонецЕсли;
		
	СтрокаВозврата = СтрокаВозврата + ".";
	
	Возврат СтрокаВозврата;
	
КонецФункции

#КонецОбласти
